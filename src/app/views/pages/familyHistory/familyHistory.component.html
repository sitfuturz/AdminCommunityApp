<div class="container-fluid">
  <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
    <!-- Header -->
    <div class="card-header bg-gradient-primary d-flex justify-content-between align-items-center py-3">
      <h4 class="mb-0 fw-bold text-white">
        <i class="bi bi-diagram-3 me-2"></i>Family History
      </h4>
      <!-- <div class="badge bg-light text-primary rounded-pill px-3 py-2">
        {{familyHistory?.pagination?.totalDocs || 0}} Users
      </div> -->
    </div>

    <!-- Search and Controls -->
    <div class="card-body p-0">
      <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
        <div class="d-flex w-100 align-items-center">
          <div class="flex-grow-1 me-2">
            <div class="position-relative">
              <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
              <input type="text" class="form-control ps-5 rounded-pill"
                    placeholder="Search users or family members..."
                    [(ngModel)]="searchQuery"
                    (input)="onSearch()">
            </div>
          </div>
          <!-- <div>
            <ng-select [items]="[5,10,15,25]" 
                      (change)="onChange()" 
                      [(ngModel)]="payload.limit" 
                      placeholder="Items per page"
                      class="custom-select">
            </ng-select>
          </div> -->
        </div>
      </div>
    </div>
     
    <!-- Loading State -->
    <div *ngIf="loading" class="text-center my-5 py-5">
      <div class="spinner-grow text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="text-muted mt-3">Loading family histories...</p>
    </div>

    <!-- Family Tree Content -->
    <div class="family-tree-container" *ngIf="!loading && familyHistory?.users && familyHistory.users.length > 0">
      <div class="p-4">
        <!-- User Nodes -->
        <div *ngFor="let userData of familyHistory.users; let userIndex = index" 
             class="user-node-container mb-5">
          
          <!-- Main User Node -->
          <div class="main-user-node d-flex align-items-center position-relative">
            <!-- User Avatar -->
            <div class="user-avatar rounded-circle d-flex align-items-center justify-content-center text-white fw-bold me-4"
                 [style.background-color]="getAvatarColor(userData.user.name)">
              {{getInitials(userData.user.name)}}
            </div>
            
            <!-- User Info -->
            <div class="user-info flex-grow-1">
              <h5 class="mb-1 fw-bold text-dark">
                {{formatName(userData.user.name)}}
              </h5>
              <div class="user-details">
                <div class="d-flex align-items-center mb-1">
                  <i class="bi bi-envelope text-muted me-2"></i>
                  <span class="text-muted small">{{formatEmail(userData.user.email)}}</span>
                </div>
                <div class="d-flex align-items-center" *ngIf="userData.user?.mobileNo">
                  <i class="bi bi-phone text-muted me-2"></i>
                  <span class="text-muted small">{{formatPhoneNumber(userData.user.mobileNo)}}</span>
                </div>
              </div>
            </div>
            
            <!-- Trees Count Badge -->
            <div class="trees-count-badge">
              <span class="badge bg-primary rounded-pill">
                {{getUserTreesCount(userData)}} Trees
              </span>
            </div>
            
            <!-- Expand/Collapse Button -->
            <button class="btn btn-outline-primary btn-sm rounded-circle ms-3"
                    (click)="toggleUserExpansion(userData.user.userId)"
                    *ngIf="getUserTreesCount(userData) > 0">
              <i class="bi" 
                 [ngClass]="isUserExpanded(userData.user.userId) ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
            </button>
          </div>
          
          <!-- Connection Line to Trees -->
          <div class="connection-line" 
               *ngIf="getUserTreesCount(userData) > 0 && isUserExpanded(userData.user.userId)"></div>
          
          <!-- Family Trees -->
          <div class="trees-container" 
               *ngIf="getUserTreesCount(userData) > 0 && isUserExpanded(userData.user.userId)">
            
            <div *ngFor="let tree of userData.trees; let treeIndex = index; let isLast = last" 
                 class="tree-node position-relative">
              
              <!-- Vertical Line -->
              <div class="vertical-line" *ngIf="!isLast"></div>
              
              <!-- Horizontal Connection -->
              <div class="horizontal-connector"></div>
              
              <!-- Tree Node Content -->
              <div class="tree-content d-flex align-items-center">
                <!-- Tree Icon -->
                <div class="tree-icon rounded-circle d-flex align-items-center justify-content-center me-3">
                  <i class="bi bi-person-circle text-white"></i>
                </div>
                
                <!-- Tree Details -->
                <div class="tree-details">
                  <h6 class="mb-1 fw-semibold text-dark">
                    {{formatName(tree.rootNode.name)}}
                  </h6>
                  <div class="tree-meta d-flex align-items-center">
                    <span class="badge bg-light text-primary me-2">
                      {{formatRelation(tree.rootNode.relation)}}
                    </span>
                    <small class="text-muted">
                      ID: {{tree.treeId?.substring(0, 8)}}...
                    </small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Empty State for User with No Trees -->
          <div *ngIf="getUserTreesCount(userData) === 0" class="empty-trees-state text-center py-3">
            <i class="bi bi-tree text-muted fs-4 mb-2"></i>
            <p class="text-muted small mb-0">No family trees available</p>
          </div>
        </div>
      </div>
      
      <!-- Pagination -->
      <div class="d-flex justify-content-center p-3 border-top" 
           *ngIf="familyHistory.pagination.totalPages > 1">
        <pagination-controls (pageChange)="onPageChange($event)"
                           [responsive]="true"
                           [maxSize]="5">
        </pagination-controls>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loading && (!familyHistory?.users || familyHistory.users.length === 0)" 
         class="text-center my-5 py-4 px-4">
      <div class="empty-state">
        <i class="bi bi-diagram-3 fs-1 text-muted mb-3"></i>
        <h5>No Family History Found</h5>
        <p class="text-muted">
          {{searchQuery ? 'Try adjusting your search criteria.' : 'No family trees have been created yet.'}}
        </p>
        <button class="btn btn-outline-primary rounded-pill mt-3" 
                *ngIf="searchQuery" 
                (click)="searchQuery=''; onSearch()">
          <i class="bi bi-arrow-clockwise me-2"></i>Clear Search
        </button>
      </div>
    </div>
  </div>
</div>