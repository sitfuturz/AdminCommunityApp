<div class="container-fluid py-4">
  <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
    <div class="card-header header-bg d-flex justify-content-between align-items-center py-3 px-4">
      <h4 class="mb-0 fw-bold text-white">
        <i class="bi bi-wallet me-2"></i>Income/Expense Management
      </h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-light btn-sm" (click)="openOpeningBalanceModal()">
          <i class="bi bi-bank me-1"></i>Set Opening Balance
        </button>
        <button class="btn btn-success btn-sm" (click)="openIncomeModal()">
          <i class="bi bi-plus-circle me-1"></i>Add Income
        </button>
        <button class="btn btn-danger btn-sm" (click)="openExpenseModal()">
          <i class="bi bi-dash-circle me-1"></i>Add Expense
        </button>
      </div>
    </div>
    <div class="card-body p-0">
      <!-- Balance Display -->
      <div class="p-4 bg-light border-bottom">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="balance-card p-3 bg-white rounded shadow-sm">
              <h6 class="text-muted mb-2">Current Balance</h6>
              <h3 class="fw-bold text-primary" *ngIf="balance; else noBalance">
                ₹{{ balance.currentBalance.toFixed(2) }}
              </h3>
              <ng-template #noBalance>
                <p class="text-warning mb-0">No balance set. Please set an opening balance.</p>
              </ng-template>
            </div>
          </div>
          <div class="col-md-6">
            <div class="balance-card p-3 bg-white rounded shadow-sm">
              <h6 class="text-muted mb-2">Opening Balance</h6>
              <h3 class="fw-bold text-primary" *ngIf="transactionsWithBalance; else noOpeningBalance">
                ₹{{ transactionsWithBalance.openingBalance.toFixed(2) }}
              </h3>
              <ng-template #noOpeningBalance>
                <p class="text-muted mb-0">No opening balance recorded.</p>
              </ng-template>
            </div>
          </div>
        </div>
      </div>

      <!-- Search and Filters -->
      <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
        <div class="d-flex w-100 align-items-center gap-3">
          <div class="flex-grow-1">
            <div class="input-group">
              <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
              <input
                type="text"
                class="form-control border-start-0"
                placeholder="Search transactions by description"
                [(ngModel)]="searchQuery"
                (input)="onSearch()"
              />
            </div>
          </div>
          <div class="w-150px">
            <ng-select
              [items]="[10, 25, 50, 100]"
              (change)="onChange()"
              [(ngModel)]="payload.limit"
              placeholder="Items per page"
              class="custom-ng-select"
            ></ng-select>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="loading" class="text-center my-5 py-5">
        <div class="spinner-grow text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>

      <!-- Transaction Table -->
      <div *ngIf="!loading && transactionsWithBalance && transactionsWithBalance.transactions && transactionsWithBalance.transactions.length > 0" class="table-responsive p-3">
        <table class="table table-hover align-middle mb-0">
          <thead class="bg-light">
            <tr>
              <th class="ps-4 py-3" style="width: 15%">Type</th>
              <th class="py-3" style="width: 15%">Amount</th>
              <th class="py-3">Description</th>
              <th class="py-3" style="width: 15%">Created At</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let transaction of transactionsWithBalance.transactions | paginate: { itemsPerPage: payload.limit, currentPage: payload.page, totalItems: transactionsWithBalance.transactions.length }; let i = index" class="border-bottom">
              <td class="ps-4 py-3">
                <span class="badge rounded-pill" [ngClass]="getTypeBadgeClass(transaction.type)">
                  {{ transaction.type | titlecase }}
                </span>
              </td>
              <td class="py-3">
                <span [ngClass]="getAmountClass(transaction.type)">
                  {{ formatAmount(transaction.amount, transaction.type) }}
                </span>
              </td>
              <td class="py-3">{{ transaction.description }}</td>
              <td class="py-3">{{ formatDate(transaction.createdAt) }}</td>
            </tr>
          </tbody>
        </table>

        <div class="d-flex justify-content-end p-3">
          <pagination-controls (pageChange)="onPageChange($event)" class="custom-pagination"></pagination-controls>
        </div>
      </div>

      <!-- Empty State -->
      <div
        *ngIf="!loading && (!transactionsWithBalance || !transactionsWithBalance.transactions || transactionsWithBalance.transactions.length === 0)"
        class="text-center my-5 py-4 px-4"
      >
        <div class="empty-state">
          <i class="bi bi-wallet fs-1 text-muted mb-3"></i>
          <h5>No Transactions Found</h5>
          <p class="text-muted">No transactions available at the moment.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Opening Balance Modal -->
  <div class="modal fade" [ngClass]="{ 'show d-block': showOpeningBalanceModal }" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content rounded-4 shadow">
        <div class="modal-header bg-light border-0">
          <h5 class="modal-title fw-bold">Set Opening Balance</h5>
          <button type="button" class="btn-close" (click)="closeOpeningBalanceModal()"></button>
        </div>
        <div class="modal-body">
          <form [formGroup]="openingBalanceForm">
            <div class="mb-3">
              <label for="amount" class="form-label fw-medium">Amount</label>
              <div class="input-group">
                <span class="input-group-text">₹</span>
                <input
                  type="number"
                  class="form-control"
                  id="amount"
                  formControlName="amount"
                  placeholder="Enter amount"
                  min="0"
                  step="0.01"
                />
              </div>
              <small class="text-danger" *ngIf="openingBalanceForm.get('amount')?.invalid && openingBalanceForm.get('amount')?.touched">
                Please enter a valid amount (minimum 0).
              </small>
            </div>
            <div class="mb-3">
              <label for="description" class="form-label fw-medium">Description (Optional)</label>
              <input
                type="text"
                class="form-control"
                id="description"
                formControlName="description"
                placeholder="Enter description"
              />
            </div>
          </form>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-secondary" (click)="closeOpeningBalanceModal()">Cancel</button>
          <button
            type="button"
            class="btn btn-primary"
            (click)="submitOpeningBalance()"
            [disabled]="openingBalanceForm.invalid"
          >
            Set Balance
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Income Modal -->
  <div class="modal fade" [ngClass]="{ 'show d-block': showIncomeModal }" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content rounded-4 shadow">
        <div class="modal-header bg-light border-0">
          <h5 class="modal-title fw-bold">Add Income</h5>
          <button type="button" class="btn-close" (click)="closeIncomeModal()"></button>
        </div>
        <div class="modal-body">
          <form [formGroup]="incomeForm">
            <div class="mb-3">
              <label for="incomeAmount" class="form-label fw-medium">Amount</label>
              <div class="input-group">
                <span class="input-group-text">₹</span>
                <input
                  type="number"
                  class="form-control"
                  id="incomeAmount"
                  formControlName="amount"
                  placeholder="Enter amount"
                  min="0.01"
                  step="0.01"
                />
              </div>
              <small class="text-danger" *ngIf="incomeForm.get('amount')?.invalid && incomeForm.get('amount')?.touched">
                Please enter a valid amount (minimum 0.01).
              </small>
            </div>
            <div class="mb-3">
              <label for="incomeDescription" class="form-label fw-medium">Description</label>
              <input
                type="text"
                class="form-control"
                id="incomeDescription"
                formControlName="description"
                placeholder="Enter description"
              />
              <small class="text-danger" *ngIf="incomeForm.get('description')?.invalid && incomeForm.get('description')?.touched">
                Description is required.
              </small>
            </div>
          </form>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-secondary" (click)="closeIncomeModal()">Cancel</button>
          <button
            type="button"
            class="btn btn-success"
            (click)="submitIncome()"
            [disabled]="incomeForm.invalid"
          >
            Add Income
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Expense Modal -->
  <div class="modal fade" [ngClass]="{ 'show d-block': showExpenseModal }" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content rounded-4 shadow">
        <div class="modal-header bg-light border-0">
          <h5 class="modal-title fw-bold">Add Expense</h5>
          <button type="button" class="btn-close" (click)="closeExpenseModal()"></button>
        </div>
        <div class="modal-body">
          <form [formGroup]="expenseForm">
            <div class="mb-3">
              <label for="expenseAmount" class="form-label fw-medium">Amount</label>
              <div class="input-group">
                <span class="input-group-text">₹</span>
                <input
                  type="number"
                  class="form-control"
                  id="expenseAmount"
                  formControlName="amount"
                  placeholder="Enter amount"
                  min="0.01"
                  step="0.01"
                />
              </div>
              <small class="text-danger" *ngIf="expenseForm.get('amount')?.invalid && expenseForm.get('amount')?.touched">
                Please enter a valid amount (minimum 0.01).
              </small>
            </div>
            <div class="mb-3">
              <label for="expenseDescription" class="form-label fw-medium">Description</label>
              <input
                type="text"
                class="form-control"
                id="expenseDescription"
                formControlName="description"
                placeholder="Enter description"
              />
              <small class="text-danger" *ngIf="expenseForm.get('description')?.invalid && expenseForm.get('description')?.touched">
                Description is required.
              </small>
            </div>
          </form>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-secondary" (click)="closeExpenseModal()">Cancel</button>
          <button
            type="button"
            class="btn btn-danger"
            (click)="submitExpense()"
            [disabled]="expenseForm.invalid"
          >
            Add Expense
          </button>
        </div>
      </div>
    </div>
  </div>
</div>